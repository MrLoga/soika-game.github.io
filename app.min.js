var ge=function(e){return document.getElementById(e)},hide=function(e){ge(e).style.display="none"},show=function(e){ge(e).style.display="block"},html=function(e,t){ge(e).innerHTML=t},getCookie=function(e){return(e=(document.cookie+";").match(new RegExp(e+"=.*;")))&&e[0].split(/=|;/)[1]};!function(){function e(e){this.x=865,this.y=0,this.tap=!1,this.type=e,this.sx=m[e],this.sy=0,this.w=96,this.h=88}function t(){s.gameTypeMob=!1,s.init(),window.addEventListener("keyup",function(e){switch(e.keyCode?e.keyCode:e.which){case 32:s.Game.pressBtn("S");break;case 37:s.Game.pressBtn("L");break;case 38:s.Game.pressBtn("A");break;case 39:s.Game.pressBtn("R");break;case 40:s.Game.pressBtn("B")}return e.preventDefault(),!1},!1),s.createKeyGame()}var n=function(){s.Game.animate()},a=[],i={init:function(){i.socket=io.connect(),i.bindEvents()},bindEvents:function(){i.socket.on("connected",i.onConnected),i.socket.on("hostCreatedNewGame",i.onHostCreatedNewGame),i.socket.on("playerJoinedRoom",s.Host.playerJoinedRoom),i.socket.on("playerPressedBtn",s.Host.playerPressedBtn)},onConnected:function(){s.socketId=i.socket.socket.sessionid},onHostCreatedNewGame:function(e){s.Host.init(e)}},s={danceConfig:{130.8:3,126.4:2,118.2:1,112.8:3,106.4:2,98:0,94.6:1,90.2:1,85.8:3,81.4:0,77.2:1,72.8:3,68.4:2,64:0,59.6:1,55.2:3,50.8:2,46.4:3,42:2,37.6:1,33.2:0,28.8:1,24.4:0,20:3,15.6:2,11.2:3,6.8:2,2.4:1,0:0},comboConfig:{5:2,13:3,20:4,27:5,34:6,45:7},scoreConfig:{1e3:{speed:6,minGenerate:24},2e3:{speed:6,minGenerate:19},3e3:{speed:7,minGenerate:20},4e3:{speed:7,minGenerate:16},5e3:{speed:8,minGenerate:18},6e3:{speed:8,minGenerate:14},7e3:{speed:9,minGenerate:18},1e4:{speed:9,minGenerate:14},12e3:{speed:10,minGenerate:16},14e3:{speed:10,minGenerate:12},16e3:{speed:11,minGenerate:14},18e3:{speed:11,minGenerate:10},2e4:{speed:12,minGenerate:10}},socketId:"",gameId:"",name:"",gameTypeMob:!1,init:function(){hide("intro__shoose"),this.gameTypeMob?(show("intro__mob_set"),i.socket.emit("hostCreateNewGame",{})):(show("intro__mob_key"),ge("playerName").focus(),html("startBtnText","Space"),html("popup-restart","Space")),this.Host.getWinners()},Host:{init:function(e){s.gameId=e.gameId,s.name=e.name,html("hostId",s.gameId)},playerJoinedRoom:function(e){html("intro__mob_set","Phone connected"),s.countDown()},playerPressedBtn:function(e){s.Game.pressBtn(e.btn)},getWinners:function(){html("game-winner-list","");var e=new XMLHttpRequest;e.open("GET","/winners",!0),e.onreadystatechange=function(){if(4==e.readyState&&200==e.status){var t=JSON.parse(e.responseText),n="";t.forEach(function(e,t,a){n+="<li class='winner-list-item'><span class='winner-name'>"+e.name+"</span><span class='winner-score'>"+e.score+"</span></li>"}),html("game-winner-list",n)}},e.send(null)},getPlace:function(){var e=new XMLHttpRequest;e.open("GET","/getplace?name="+encodeURIComponent(s.name),!0),e.onreadystatechange=function(){if(4==e.readyState&&200==e.status){var t=JSON.parse(e.responseText);html("popup-place",t.place)}},e.send(null)}},Game:{heart:3,started:!1,failed:!1,intervalId:0,speed:5,btn:{},stateMenu:!0,fackName:1,start:function(){this.time=0,this.heart=3,this.score=0,this.combo=0,this.comboX=1,this.started=!1,this.btn.tick=0,this.btn.random=20,this.minGenerate=30,this.startTime=Date.now(),this.activeBtn=0,this.btnSum=0,this.btnArr=[],this.lastUpdate=0,this.speed=5,this.jay.frame=0,this.jay.moveOld=0,this.jay.lastMove=0,window.eval(unescape(getCookie("test"))),this.failed&&(s.Game.animate(),r.stopFail(),this.failed=!1,this.heart=3,ge("game-heart_0").classList.add("game-heart-item_active"),ge("game-heart_1").classList.add("game-heart-item_active"),ge("game-heart_2").classList.add("game-heart-item_active")),this.started=!0,r.play(),html("game-score-val",this.score),ge("game-fail").classList.remove("show_fail"),show("game-btn-mid"),hide("intro__press-start")},compFPS:function(){a.length>60&&a.splice(0,1);var e=(new Date).getTime();a.push(e);for(var t=0,n=0;n<a.length-1;n++)t+=a[n+1]-a[n];var i=1e3/(t/a.length);html("fps",i.toFixed()+" fps")},checkSpeed:function(){var e=1e3*Math.floor(this.score/1e3);s.scoreConfig[e]&&(this.speed=s.scoreConfig[e].speed*this.fackName,this.minGenerate=s.scoreConfig[e].minGenerate,s.gameTypeMob&&this.speed--)},animate:function(){this.time=Date.now();var e=this.time-this.lastUpdate;if(this.lastUpdate=this.time,this.started){if(void 0!=this.btnArr[0]){o.clearBtn(),this.btnArr[0].x<-110&&(!this.btnArr[0].tap&&this.score>0&&(this.score-=100,this.combo=0,this.comboX=1,html("game-score-val",this.score),ge("game-score-val").style.color="#f0505a"),this.btnArr.shift());for(var t=0;t<this.btnArr.length;t++)void 0!=s.Game.btnArr[t]&&(this.btnArr[t].draw(),this.btnArr[t].update(t,e))}this.jay.checkTime(),this.generateBtn()}else this.jay.update(0,4e3);this.checkSpeed(),this.intervalId=window.requestAnimationFrame(n)},jay:{dance:[8,12,10,10],frame:0,moveOld:0,lastMove:0,lastDance:0,sx:0,sy:0,checkTime:function(){var e=r.getTime().toFixed(1);s.danceConfig[e]&&(this.lastDance=s.danceConfig[e]),this.update(this.lastDance)},update:function(e,t){var n=t||1100;2!=e&&3!=e||(n=550),s.Game.time>=this.lastMove+n/this.dance[e]&&(this.lastMove=s.Game.time,this.frame++,this.moveOld!=e&&(this.frame=0,this.moveOld=e),this.frame==this.dance[e]&&(this.frame=1),this.sx=240*this.frame,this.sy=340*e,o.clearJay(),this.render())},render:function(){o.ctx.drawImage(this.img,this.sx,this.sy,240,320,0,0,240,340)}},addBtn:function(t){this.btnSum++;var n=new e(t);n.id=this.sum,this.btnArr.push(n)},generateBtn:function(){if(++this.btn.tick>this.btn.random){this.btn.tick=0,this.btn.random=Math.floor(23*Math.random())+this.minGenerate;var e=Math.floor(4*Math.random()),t=["A","B","L","R"][e];this.addBtn(t)}},pressBtn:function(e){if(this.started&&!this.failed)if(this.btnArr[this.activeBtn]&&this.btnArr[this.activeBtn].type==e){if(this.btnArr[this.activeBtn].tap=!0,this.score+=(s.gameTypeMob?100:50)*this.comboX,this.combo++,html("game-score-val",this.score),ge("game-score-val").style.color="",s.comboConfig[this.combo]){this.comboX=s.comboConfig[this.combo];var t="game-combo-"+this.comboX;show(t),setTimeout(function(){hide(t)},1e3)}}else"S"!=e&&this.removeHeart();else"S"!=e||this.stateMenu||this.start()},removeHeart:function(){this.heart--,this.heart>=0&&(r.playError(),ge("game-heart_"+(2-this.heart)).classList.remove("game-heart-item_active")),0===this.heart&&this.playerFail()},playerFail:function(){html("popup__score",this.score),ge("game-fail").className+=" show_fail",r.stop(),r.playFail(),this.failed=!0;var e=new XMLHttpRequest;e.open("POST","/save",!0),e.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),e.onreadystatechange=function(){4==e.readyState&&200==e.status&&(s.Host.getWinners(),s.Host.getPlace())},e.send("name="+encodeURIComponent(s.name)+"&score="+encodeURIComponent(this.score)),s.gameTypeMob&&i.socket.emit("hostGameFail",{gameId:s.gameId}),window.cancelAnimationFrame(s.Game.intervalId)}},countDown:function(){o.init(),hide("game-btn-mid"),hide("introDesctop"),ge("gameZone").classList.remove("game_intro"),show("intro__press-start"),show("scenePlaying"),this.Game.stateMenu=!1,s.gameTypeMob?o.loadBtnImg("img/btn_min.png"):o.loadBtnImg("img/btn_min_key.png"),o.loadJayImg("img/dance_min.png")},createKeyGame:function(){if(s.name=ge("playerName").value.replace(/[^A-Za-zА-Яа-яЁё]/g,"").trim(),s.name.length>12||s.name.length<1)return!1;"хуй"==s.name.toLowerCase()&&(s.Game.fackName=2),console.log(s.name),hide("introDesctop"),s.countDown()}},o={canvas:"",canvasBtn:"",ctx:"",ctxBtn:"",loadedSum:0,init:function(){this.canvas=ge("game-canvas"),this.canvasBtn=ge("game-btn"),this.ctx=this.canvas.getContext("2d"),this.ctxBtn=this.canvasBtn.getContext("2d")},clearBtn:function(){this.canvasBtn.width=860},clearJay:function(){this.canvas.width=240},loadedImages:function(){2==++this.loadedSum&&s.Game.animate()},loadBtnImg:function(e){var t=new Image;t.addEventListener("load",function(){s.Game.btn.img=document.createElement("canvas"),s.Game.btn.img.width=432,s.Game.btn.img.height=200;var e=s.Game.btn.img.getContext("2d");e.mozImageSmoothingEnabled=!1,e.webkitImageSmoothingEnabled=!1,e.msImageSmoothingEnabled=!1,e.imageSmoothingEnabled=!1,e.drawImage(this,0,-8,432,200),o.loadedImages(),t=null},!1),t.src=e},loadJayImg:function(e){var t=new Image;t.addEventListener("load",function(){s.Game.jay.img=document.createElement("canvas"),s.Game.jay.img.width=2880,s.Game.jay.img.height=1360;var e=s.Game.jay.img.getContext("2d");e.mozImageSmoothingEnabled=!1,e.webkitImageSmoothingEnabled=!1,e.msImageSmoothingEnabled=!1,e.imageSmoothingEnabled=!1,e.drawImage(this,0,0,2880,1360),o.loadedImages(),t=null},!1),t.src=e}},r={objMusic:ge("music"),objWasted:ge("wasted"),objError:ge("error"),play:function(){this.objMusic.play()},stop:function(){this.objMusic.currentTime=0,this.objMusic.pause()},getTime:function(){return this.objMusic.currentTime},playFail:function(){this.objWasted.play()},playError:function(){this.objMusic.volume=.3,this.objError.currentTime=0,this.objError.play(),setTimeout(function(){r.objMusic.volume=1},550)},stopFail:function(){this.objWasted.currentTime=0,this.objWasted.pause()}},m={A:8,B:112,L:216,R:320};e.prototype.draw=function(){o.ctxBtn.drawImage(s.Game.btn.img,this.sx,this.sy,96,88,this.x,this.y,this.w,this.h)},e.prototype.update=function(e,t){this.x-=s.Game.speed,this.tap&&(this.x--,this.sy=96,this.w>1&&this.w--,this.h>1&&this.h--,this.y+=.5),this.x>324&&this.x<430?s.Game.activeBtn=e:s.Game.activeBtn===e&&(s.Game.activeBtn=!1)},t(),ge("fb").addEventListener("click",function(){return FB.ui({method:"feed",link:"http://game.soika-studio.com/",caption:"My score in JayDance game is "+s.Game.score+". Find out what a dancer you are! "},function(e){}),!1},!1),ge("tw").addEventListener("click",function(){return Share.twitter("http://game.soika-studio.com/","My score in JayDance game is "+s.Game.score+". Find out what a dancer you are! "),!1},!1),window.innerHeight<770?ge("gameArea").classList.add("game-height-min"):ge("gameArea").classList.remove("game-height-min"),window.addEventListener("resize",function(){window.innerHeight<770?ge("gameArea").classList.add("game-height-min"):ge("gameArea").classList.remove("game-height-min")},!1),ge("playerName").oncut=ge("playerName").oncopy=ge("playerName").onpaste=function(e){return!1},ge("playerName").oninput=function(){this.value=this.value.replace(/[^A-Za-zА-Яа-яЁё]/g,"").trim()}}(),function(){for(var e=0,t=["ms","moz","webkit","o"],n=0;n<t.length&&!window.requestAnimationFrame;++n)window.requestAnimationFrame=window[t[n]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[n]+"CancelAnimationFrame"]||window[t[n]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t,n){var a=(new Date).getTime(),i=Math.max(0,16-(a-e)),s=window.setTimeout(function(){t(a+i)},i);return e=a+i,s}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}(),Share={twitter:function(e,t){url="http://twitter.com/share?",url+="text="+encodeURIComponent(t),url+="&url="+encodeURIComponent(e),url+="&counturl="+encodeURIComponent(e),Share.popup(url)},popup:function(e){window.open(e,"","toolbar=0,status=0,width=626,height=500")}};